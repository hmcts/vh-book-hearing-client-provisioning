# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

# Set variables once
variables:
  - group: 'vh-vsts-automation'  # another variable group
  - group: 'Azure AD Tenant - hearings.reform.hmcts.net'
  - name: service # name of a variable
    value: vh-app-api # value of the variable
  - name: environment # name of a variable
    value: jb # value of the variable
  - name: environmentName # name of a variable
    value: '' # value of the variable




trigger:
- master
pr:
- master

jobs:
- job: 
  displayName: 'Build & Test Java Script and .Net Core'
  pool: Azure-VSTS-VS2017

  # Reference templae for setting up build tools
  steps:
  - checkout: self  # self represents the repo where the initial Pipelines YAML file was found
    clean: true  # whether to fetch clean each time

  - powershell: git clone https://github.com/hmcts/vh-ps-modules.git

  - powershell: | 
      #Get-ChildItem -Recurse
      Install-Module AzureAD
      Install-Module AzureRM.KeyVault
      Copy-Item -Path $(System.DefaultWorkingDirectory)/*vh-ps-modules/AzureADApplicationRegistration -Destination "C:\Program Files\WindowsPowerShell\Modules" -Recurse -Force

  - powershell: | 
     write-host $(AzureTenantID)
    displayName: Say hello
    name: testPS
    env:
      AzureTenantID: $(vh_teantid)
      AzureVSTSAutomation: 

  - powershell: | 
     Invoke-AzureADApplicationRegistration `
     -AzureTenantId '$(AzureTenantID)'' ` 
     -AzureAdAppId '$(AzureVSTSAutomation)' `
     -AzureAdAppCertificateThumbprint '$(AzureVSTSAutomationCertThumbprint)' `
     -AzureSubscriptionId '$(AzureSubscriptionID)' `
     -AzureADApplicationName '$(AzureADApplicationName )_$(Release.EnvironmentName)' `
     -AzureKeyVaultName '$(AzureKeyVaultName)' `
     -AzureTenantIdSecondary '$(AzureTenantIdSecondary)' `
     -AzureAdAppIdSecondary '$(AzureAdAppIdSecondary)' `
     -AzureAdAppCertificateThumbprintSecondary '$(AzureAdAppCertificateThumbprintSecondary)'
    displayName: Say hello
    name: firstStep
    env:
      AzureTenantID: $(vh_teantid)
      AzureVSTSAutomation: 



